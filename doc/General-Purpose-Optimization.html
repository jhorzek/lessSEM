<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>General-Purpose-Optimization</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">General-Purpose-Optimization</h1>



<p><strong>lessSEM</strong> can be used for regularized SEM and for
general purpose optimization. That is, you can use all optimizers and
penalty functions implemented in <strong>lessSEM</strong> for your own
models. To this end, you must define a fitting function; i.e., a
function which takes in the parameters and returns a single value - the
unregularized fit. <strong>lessSEM</strong> then uses this fitting
function and adds the penalty terms. The combined fitting function is
then optimized. Currently, there are three ways to use the optimizers in
<strong>lessSEM</strong></p>
<ol style="list-style-type: decimal">
<li>You can use the R interface. This interface is very similar to that
of optim (see e.g., <code>?lessSEM::gpLasso</code>).</li>
<li>If your functions are defined in C++, you can use a faster interface
which is a bit more involved (see e.g.,
<code>?lessSEM::gpLassoCpp</code>).</li>
<li>You can include the header files of <strong>lessSEM</strong> in your
package to directly interface to the underlying C++ functions. This is
the most complicated approach.</li>
</ol>
<p>In general, the approaches get faster as you transition from 1 to 3.
You will see the largest performance gains when implementing a gradient
function and not just a fitting function, however. As a rule of thumb:
Use approach 1 if you intend to run your model a few times, donâ€™t want
to create a new package and your model runs fairly fast. Use approach 2
if you want to increase the speed a bit, while keeping the changes
necessary to your files manageable. Use approach 3 if you create a new
package, have some experience with <strong>RcppArmadillo</strong> and
want to get the best performance.</p>
<p>In the following, we will demonstrate all three approaches using a
linear regression model as an example.</p>
<div id="the-example" class="section level2">
<h2>The example</h2>
<p>Letâ€™s start by setting up our linear regression model. To this end,
we will simulate a data set:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># first, we simulate data for our</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># linear regression.</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="co"># number of persons</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="co"># number of predictors</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(N<span class="sc">*</span>p), <span class="at">nrow =</span> N, <span class="at">ncol =</span> p) <span class="co"># design matrix</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>,<span class="dv">4</span>),</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>       <span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">6</span>)) <span class="co"># true regression weights</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> X<span class="sc">%*%</span><span class="fu">matrix</span>(b,<span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,.<span class="dv">2</span>)</span></code></pre></div>
</div>
<div id="the-first-approach-interfacing-from-r" class="section level2">
<h2>The first approach: Interfacing from R</h2>
<p>We will now try to implement a lasso regularized linear regression
using the gpLasso interface. This interface is very similar to
<code>optim</code>. To use it, we must define our fitting function in
R:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># defining the sum-squared-errors:</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>sseFun <span class="ot">&lt;-</span> <span class="cf">function</span>(par, y, X, N){</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># par is the parameter vector</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># y is the observed dependent variable</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X is the design matrix</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># N is the sample size</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  pred <span class="ot">&lt;-</span> X <span class="sc">%*%</span> <span class="fu">matrix</span>(par, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="co">#be explicit here:</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># we need par to be a column vector</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  sse <span class="ot">&lt;-</span> <span class="fu">sum</span>((y <span class="sc">-</span> pred)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># we scale with .5/N to get the same results as glmnet</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>((.<span class="dv">5</span><span class="sc">/</span>N)<span class="sc">*</span>sse)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Additionally, we need a <em>labeled</em> vector with starting
values:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>par <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, p<span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(par) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;b&quot;</span>, <span class="dv">0</span><span class="sc">:</span>p)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(par)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  b0  b1  b2  b3  b4  b5  b6  b7  b8  b9 b10 </span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   0   0   0   0   0   0   0   0   0   0   0</span></span></code></pre></div>
<p>Note that we defined one more parameter than there are variables in
X. This is because we also want to estimate the intercept. To this end,
we extend X:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>Xext <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>,X)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Xext)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;      [,1]        [,2]        [,3]       [,4]       [,5]        [,6]        [,7]</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1,]    1 -0.56047565 -0.71040656  2.1988103 -0.7152422 -0.07355602 -0.60189285</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [2,]    1 -0.23017749  0.25688371  1.3124130 -0.7526890 -1.16865142 -0.99369859</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [3,]    1  1.55870831 -0.24669188 -0.2651451 -0.9385387 -0.63474826  1.02678506</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [4,]    1  0.07050839 -0.34754260  0.5431941 -1.0525133 -0.02884155  0.75106130</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [5,]    1  0.12928774 -0.95161857 -0.4143399 -0.4371595  0.67069597 -1.50916654</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [6,]    1  1.71506499 -0.04502772 -0.4762469  0.3311792 -1.65054654 -0.09514745</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;             [,8]       [,9]      [,10]      [,11]</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1,]  1.07401226 -0.7282191  0.3562833 -1.0141142</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [2,] -0.02734697 -1.5404424 -0.6580102 -0.7913139</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [3,] -0.03333034 -0.6930946  0.8552022  0.2995937</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [4,] -1.51606762  0.1188494  1.1529362  1.6390519</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [5,]  0.79038534 -1.3647095  0.2762746  1.0846170</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [6,] -0.21073418  0.5899827  0.1441047 -0.6245675</span></span></code></pre></div>
<p>Finally, we need to decide which parameters should be regularized and
the values for lambda. We want to regularize everything except for the
intercept:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>(regularized <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;b&quot;</span>, <span class="dv">1</span><span class="sc">:</span>p))</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [1] &quot;b1&quot;  &quot;b2&quot;  &quot;b3&quot;  &quot;b4&quot;  &quot;b5&quot;  &quot;b6&quot;  &quot;b7&quot;  &quot;b8&quot;  &quot;b9&quot;  &quot;b10&quot;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>lambdas  <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>,.<span class="dv">1</span>,<span class="at">length.out =</span> <span class="dv">20</span>)</span></code></pre></div>
<p>Now, we are ready to estimate the model:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lessSEM)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>l1 <span class="ot">&lt;-</span> <span class="fu">gpLasso</span>(<span class="at">par =</span> par, </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">regularized =</span> regularized, </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">fn =</span> sseFun, </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">lambdas =</span> lambdas, </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">X =</span> Xext,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">y =</span> y,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">N =</span> <span class="fu">length</span>(y)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(l1<span class="sc">@</span>parameters)</span></code></pre></div>
<pre><code>#&gt;        lambda alpha         b0        b1        b2        b3       b4
#&gt; 1 0.000000000     1 0.02734701 1.0129361 0.9991629 0.9705501 1.027728
#&gt; 2 0.005263158     1 0.02939279 1.0043630 0.9908706 0.9626483 1.025040
#&gt; 3 0.010526316     1 0.02991382 0.9967095 0.9846820 0.9552595 1.021995
#&gt; 4 0.015789474     1 0.03014019 0.9897303 0.9789299 0.9481703 1.018564
#&gt; 5 0.021052632     1 0.03027073 0.9827017 0.9732322 0.9410076 1.015284
#&gt; 6 0.026315789     1 0.03110657 0.9753312 0.9670617 0.9338474 1.011622
#&gt;            b5           b6           b7          b8           b9         b10
#&gt; 1 0.013993181 -0.007491534 0.0186210155 0.021974963 -0.009975776 0.027466466
#&gt; 2 0.003399218  0.000000000 0.0143125188 0.015389254 -0.007866347 0.022233946
#&gt; 3 0.000000000  0.000000000 0.0096496499 0.010743577 -0.005335925 0.017532937
#&gt; 4 0.000000000  0.000000000 0.0049093451 0.006323141 -0.002314825 0.012640961
#&gt; 5 0.000000000  0.000000000 0.0002174577 0.001971241  0.000000000 0.007906065
#&gt; 6 0.000000000  0.000000000 0.0000000000 0.000000000  0.000000000 0.003365918</code></pre>
<p>Note that we did not specify the gradients of our function. In this
case, <strong>lessSEM</strong> will use <strong>numDeriv</strong> to
compute the gradients. However, if you know how to specify the
gradients, this can result in faster estimation:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>sseGrad <span class="ot">&lt;-</span> <span class="cf">function</span>(par, y, X, N){</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  gradients <span class="ot">=</span> (<span class="sc">-</span><span class="fl">2.0</span><span class="sc">*</span><span class="fu">t</span>(X) <span class="sc">%*%</span> y <span class="sc">+</span> <span class="fl">2.0</span><span class="sc">*</span><span class="fu">t</span>(X)<span class="sc">%*%</span>X<span class="sc">%*%</span><span class="fu">matrix</span>(par,<span class="at">ncol =</span> <span class="dv">1</span>))</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  gradients <span class="ot">=</span> (.<span class="dv">5</span><span class="sc">/</span><span class="fu">length</span>(y))<span class="sc">*</span>gradients</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">t</span>(gradients))</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>l1 <span class="ot">&lt;-</span> <span class="fu">gpLasso</span>(<span class="at">par =</span> par, </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>              <span class="at">regularized =</span> regularized, </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">fn =</span> sseFun, </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">gr =</span> sseGrad,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">lambdas =</span> lambdas, </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">X =</span> Xext,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">y =</span> y,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">N =</span> <span class="fu">length</span>(y)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(l1<span class="sc">@</span>parameters)</span></code></pre></div>
<pre><code>#&gt;        lambda alpha         b0        b1        b2        b3       b4
#&gt; 1 0.000000000     1 0.02734701 1.0129361 0.9991629 0.9705501 1.027728
#&gt; 2 0.005263158     1 0.02939279 1.0043630 0.9908706 0.9626483 1.025040
#&gt; 3 0.010526316     1 0.02991382 0.9967095 0.9846820 0.9552595 1.021995
#&gt; 4 0.015789474     1 0.03014019 0.9897303 0.9789299 0.9481703 1.018564
#&gt; 5 0.021052632     1 0.03027073 0.9827017 0.9732322 0.9410076 1.015284
#&gt; 6 0.026315789     1 0.03110657 0.9753312 0.9670617 0.9338474 1.011622
#&gt;            b5           b6          b7          b8           b9         b10
#&gt; 1 0.013993181 -0.007491533 0.018621015 0.021974963 -0.009975776 0.027466466
#&gt; 2 0.003399218  0.000000000 0.014312519 0.015389254 -0.007866347 0.022233946
#&gt; 3 0.000000000  0.000000000 0.009649650 0.010743577 -0.005335925 0.017532937
#&gt; 4 0.000000000  0.000000000 0.004909345 0.006323141 -0.002314825 0.012640961
#&gt; 5 0.000000000  0.000000000 0.000217458 0.001971241  0.000000000 0.007906064
#&gt; 6 0.000000000  0.000000000 0.000000000 0.000000000  0.000000000 0.003365918</code></pre>
<p>Here is a short comparison of running both models 5 times each:</p>
<p>Runtime in seconds without gradients:</p>
<pre><code>#&gt; [1] 1.406129 1.364129 1.328224 1.324434 1.351225</code></pre>
<p>Runtime in seconds with gradients:</p>
<pre><code>#&gt; [1] 0.04891396 0.05096173 0.05036545 0.04983449 0.05140996</code></pre>
<p>Now, thatâ€™s quite a difference!</p>
<p>Note that you can also pass a C++ function to gpLasso similar to the
approach above:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RcppArmadillo)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Rcpp)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>linreg <span class="ot">&lt;-</span> <span class="st">&#39;</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="st">// [[Rcpp::depends(RcppArmadillo)]]</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="st">#include &lt;RcppArmadillo.h&gt;</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="st">// [[Rcpp::export]]</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="st">double fitfunction(const arma::colvec parameters, const arma::mat X, const arma::colvec y, const int N){</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="st">  // compute the sum of squared errors:</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="st">    arma::mat sse = arma::trans(y-X*parameters)*(y-X*parameters);</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="st">    // other packages, such as glmnet, scale the sse with </span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="st">    // 1/(2*N), where N is the sample size. We will do that here as well</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="st">    sse *= 1.0/(2.0 * N);</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="st">    // note: We must return a double, but the sse is a matrix</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="st">    // To get a double, just return the single value that is in </span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="st">    // this matrix:</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="st">      return(sse(0,0));</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="st">// [[Rcpp::export]]</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="st">arma::rowvec gradientfunction(const arma::colvec parameters, const arma::mat X, const arma::colvec y, const int N){</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a><span class="st">  // note: we want to return our gradients as row-vector; therefore,</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="st">  // we have to transpose the resulting column-vector:</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a><span class="st">    arma::rowvec gradients = arma::trans(-2.0*X.t() * y + 2.0*X.t()*X*parameters);</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a><span class="st">    // other packages, such as glmnet, scale the sse with </span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a><span class="st">    // 1/(2*N), where N is the sample size. We will do that here as well</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a><span class="st">    gradients *= (.5/N);</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a><span class="st">    return(gradients);</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a><span class="st">}&#39;</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>Rcpp<span class="sc">::</span><span class="fu">sourceCpp</span>(<span class="at">code =</span> linreg)</span></code></pre></div>
<p>Run the model as before:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>l1 <span class="ot">&lt;-</span> <span class="fu">gpLasso</span>(<span class="at">par =</span> par, </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>              <span class="at">regularized =</span> regularized, </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">fn =</span> fitfunction, </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">gr =</span> gradientfunction,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">lambdas =</span> lambdas, </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">X =</span> Xext,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">y =</span> y,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">N =</span> <span class="fu">length</span>(y)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(l1<span class="sc">@</span>parameters)</span></code></pre></div>
<pre><code>#&gt;        lambda alpha         b0        b1        b2        b3       b4
#&gt; 1 0.000000000     1 0.02734701 1.0129361 0.9991629 0.9705501 1.027728
#&gt; 2 0.005263158     1 0.02939279 1.0043630 0.9908706 0.9626483 1.025040
#&gt; 3 0.010526316     1 0.02991382 0.9967095 0.9846820 0.9552595 1.021995
#&gt; 4 0.015789474     1 0.03014019 0.9897303 0.9789299 0.9481703 1.018564
#&gt; 5 0.021052632     1 0.03027073 0.9827017 0.9732322 0.9410076 1.015284
#&gt; 6 0.026315789     1 0.03110657 0.9753312 0.9670617 0.9338474 1.011622
#&gt;            b5           b6          b7          b8           b9         b10
#&gt; 1 0.013993181 -0.007491533 0.018621015 0.021974963 -0.009975776 0.027466466
#&gt; 2 0.003399218  0.000000000 0.014312519 0.015389254 -0.007866347 0.022233946
#&gt; 3 0.000000000  0.000000000 0.009649650 0.010743577 -0.005335925 0.017532937
#&gt; 4 0.000000000  0.000000000 0.004909345 0.006323141 -0.002314825 0.012640961
#&gt; 5 0.000000000  0.000000000 0.000217458 0.001971241  0.000000000 0.007906064
#&gt; 6 0.000000000  0.000000000 0.000000000 0.000000000  0.000000000 0.003365918</code></pre>
<p>The runtime in seconds with C++ is:</p>
<pre><code>#&gt; [1] 0.03627133 0.03788137 0.03488636 0.03457785 0.03444600</code></pre>
<p>Which is even lower than what we had before!</p>
</div>
<div id="the-second-approach-using-c-function-pointers" class="section level2">
<h2>The second approach: Using C++ function pointers</h2>
<p>While using the Rcpp functions defined above was quite fast for our
linear regression, it can still be fairly slow for more involved models
(e.g., SEM). This is due to our optimizer having to go back and forth
between R and C++. To reduce this overhead, we can use the second
approach. Here, instead of passing an Rcpp function which is then
executed in R, we pass a pointer to the underlying C++ functions. This
approach is more constrained than the one presented above:</p>
<ol style="list-style-type: decimal">
<li>We must define both, a fitting function and a gradient function in
Rcpp. We cannot rely on numDeriv any more!</li>
<li>The fitting function and the gradient function are only allowed two
parameters each: a <code>const Rcpp::NumericVector&amp;</code> (the
parameters) and an <code>Rcpp::List&amp;</code> (everything else). While
this seems restrictive, note that we can virtually pass anything we want
in a list.</li>
<li>We must <a href="https://gallery.rcpp.org/articles/passing-cpp-function-pointers/">create
pointers</a> to the fit and gradient function. This is difficult,
however we will provide some guidance below.</li>
</ol>
<p>This may be a bit overwhelming at first, so we will go through it
step by step.</p>
<div id="creating-a-fitting-function-and-a-gradient-function" class="section level3">
<h3>1. Creating a fitting function and a gradient function</h3>
<p>We already defined a fitting function and a gradient function for our
linear regression model in the example above. However, we often do not
know the gradients in closed form. If you donâ€™t have a gradient
function, you can try a numerical approximation. More details can be
found <a href="https://en.wikipedia.org/wiki/Finite_difference">here</a>.</p>
</div>
<div id="adapting-the-functions-to-the-constraints" class="section level3">
<h3>2. Adapting the functions to the constraints</h3>
<p>Note that our fitting function and our gradient function do not
comply with the constraints mentioned above. That is, they do take more
than two parameters as arguments
(<code>const arma::colvec parameters, const arma::mat X, const arma::colvec y, const int N</code>),
and these arguments are not a
<code>const Rcpp::NumericVector&amp;</code> and an
<code>Rcpp::List&amp;</code>. How can we make this work? The parameter
vector <code>const Rcpp::NumericVector&amp;</code> will hold all
elements in the <code>arma::colvec pararameters</code> of our old
function. The <code>Rcpp::List&amp;</code> must contain all of the other
elements (<code>X,y,N</code>). Letâ€™s start by creating this list, which
we will call data:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">&quot;X&quot;</span> <span class="ot">=</span> Xext,</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>             <span class="st">&quot;y&quot;</span> <span class="ot">=</span> y,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>             <span class="st">&quot;N&quot;</span> <span class="ot">=</span> <span class="fu">length</span>(y))</span></code></pre></div>
<p>Next, we have to change our functions to make things work:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>linreg <span class="ot">&lt;-</span> <span class="st">&#39;</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="st">// [[Rcpp::depends(RcppArmadillo)]]</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="st">#include &lt;RcppArmadillo.h&gt;</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="st">// [[Rcpp::export]]</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="st">double fitfunction(const Rcpp::NumericVector&amp; parameters, Rcpp::List&amp; data){</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="st">  // our function now only takes the two specified arguments: a</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="st">  // const Rcpp::NumericVector&amp; and an Rcpp::List&amp;.</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="st">  // We have to extract all elements from the list:</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="st">  arma::colvec y = Rcpp::as&lt;arma::colvec&gt;(data[&quot;y&quot;]); // the dependent variable</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="st">  arma::mat X = Rcpp::as&lt;arma::mat&gt;(data[&quot;X&quot;]); // the design matrix</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="st">  int N = Rcpp::as&lt;int&gt;(data[&quot;N&quot;]); // the sample size</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="st">  // Next, we want to get the parameters as a column-vector:</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="st">    arma::colvec b = Rcpp::as&lt;arma::colvec&gt;(parameters);</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="st">  // compute the sum of squared errors:</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="st">    arma::mat sse = arma::trans(y-X*b)*(y-X*b);</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="st">    // other packages, such as glmnet, scale the sse with </span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="st">    // 1/(2*N), where N is the sample size. We will do that here as well</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="st">    sse *= 1.0/(2.0 * N);</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a><span class="st">    // note: We must return a double, but the sse is a matrix</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a><span class="st">    // To get a double, just return the single value that is in </span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="st">    // this matrix:</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a><span class="st">      return(sse(0,0));</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a><span class="st">// [[Rcpp::export]]</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a><span class="st">arma::rowvec gradientfunction(const Rcpp::NumericVector&amp; parameters, Rcpp::List&amp; data){</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a><span class="st">    // our function now only takes the two specified arguments: a</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a><span class="st">  // const Rcpp::NumericVector&amp; and an Rcpp::List&amp;.</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a><span class="st">  // We have to extract all elements from the list:</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a><span class="st">  arma::colvec y = Rcpp::as&lt;arma::colvec&gt;(data[&quot;y&quot;]); // the dependent variable</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a><span class="st">  arma::mat X = Rcpp::as&lt;arma::mat&gt;(data[&quot;X&quot;]); // the design matrix</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a><span class="st">  int N = Rcpp::as&lt;int&gt;(data[&quot;N&quot;]); // the sample size</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a><span class="st">  // Next, we want to get the parameters as a column-vector:</span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a><span class="st">    arma::colvec b = Rcpp::as&lt;arma::colvec&gt;(parameters);</span></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a><span class="st">  // note: we want to return our gradients as row-vector; therefore,</span></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a><span class="st">  // we have to transpose the resulting column-vector:</span></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a><span class="st">    arma::rowvec gradients = arma::trans(-2.0*X.t() * y + 2.0*X.t()*X*b);</span></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a><span class="st">    // other packages, such as glmnet, scale the sse with </span></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a><span class="st">    // 1/(2*N), where N is the sample size. We will do that here as well</span></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a><span class="st">    gradients *= (.5/N);</span></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a><span class="st">    return(gradients);</span></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;</span></span></code></pre></div>
<p>Thatâ€™s it, our functions have been transformed!</p>
</div>
<div id="step-3-creating-pointers-to-our-functions" class="section level3">
<h3>Step 3: Creating pointers to our functions</h3>
<p>This is where it getâ€™s really tricky! We canâ€™t just pass our
functions to C++. However, we can <a href="https://gallery.rcpp.org/articles/passing-cpp-function-pointers/">create
pointers</a>. These have to be generated in C++ and this can be tricky
to get right. To simplify the process, we have created a function which
helps setting things up:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(lessSEM<span class="sc">::</span><span class="fu">makePtrs</span>(<span class="at">fitFunName =</span> <span class="st">&quot;fitfunction&quot;</span>, <span class="co"># name of the function in C++</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">gradFunName =</span> <span class="st">&quot;gradientfunction&quot;</span> <span class="co"># name of the function in C++</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; // INSTRUCTIONS: ADD THE FOLLOWING LINES TO YOUR C++ FUNCTIONS</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; // IF RCPPARMADILLO IS NOT IMPORTED YET, UNCOMMENT THE FOLLOWING TWO LINES</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; // // [[Rcpp::depends(RcppArmadillo)]]</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; // #include &lt;RcppArmadillo.h&gt;</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; // https://gallery.rcpp.org/articles/passing-cpp-function-pointers/</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; typedef double (*fitFunPtr)(const Rcpp::NumericVector&amp;, //parameters</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;                 Rcpp::List&amp; //additional elements</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; );</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; typedef Rcpp::XPtr&lt;fitFunPtr&gt; fitFunPtr_t;</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; typedef arma::rowvec (*gradientFunPtr)(const Rcpp::NumericVector&amp;, //parameters</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;                       Rcpp::List&amp; //additional elements</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; );</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; typedef Rcpp::XPtr&lt;gradientFunPtr&gt; gradientFunPtr_t;</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; // [[Rcpp::export]]</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; fitFunPtr_t fitfunctionPtr() {</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;         return(fitFunPtr_t(new fitFunPtr(&amp;fitfunction)));</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; }</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; // [[Rcpp::export]]</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; gradientFunPtr_t gradientfunctionPtr() {</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;         return(gradientFunPtr_t(new gradientFunPtr(&amp;gradientfunction)));</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; }</span></span></code></pre></div>
<p>Letâ€™s follow the instructions and add the lines to our C++
functions:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>linreg <span class="ot">&lt;-</span> <span class="st">&#39;</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="st">// [[Rcpp::depends(RcppArmadillo)]]</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="st">#include &lt;RcppArmadillo.h&gt;</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="st">// [[Rcpp::export]]</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="st">double fitfunction(const Rcpp::NumericVector&amp; parameters, Rcpp::List&amp; data){</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="st">  // our function now only takes the two specified arguments: a</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="st">  // const Rcpp::NumericVector&amp; and an Rcpp::List&amp;.</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="st">  // We have to extract all elements from the list:</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="st">  arma::colvec y = Rcpp::as&lt;arma::colvec&gt;(data[&quot;y&quot;]); // the dependent variable</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="st">  arma::mat X = Rcpp::as&lt;arma::mat&gt;(data[&quot;X&quot;]); // the design matrix</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="st">  int N = Rcpp::as&lt;int&gt;(data[&quot;N&quot;]); // the sample size</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="st">  // Next, we want to get the parameters as a column-vector:</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="st">    arma::colvec b = Rcpp::as&lt;arma::colvec&gt;(parameters);</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="st">  // compute the sum of squared errors:</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="st">    arma::mat sse = arma::trans(y-X*b)*(y-X*b);</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a><span class="st">    // other packages, such as glmnet, scale the sse with </span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="st">    // 1/(2*N), where N is the sample size. We will do that here as well</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a><span class="st">    sse *= 1.0/(2.0 * N);</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a><span class="st">    // note: We must return a double, but the sse is a matrix</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a><span class="st">    // To get a double, just return the single value that is in </span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a><span class="st">    // this matrix:</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a><span class="st">      return(sse(0,0));</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a><span class="st">// [[Rcpp::export]]</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a><span class="st">arma::rowvec gradientfunction(const Rcpp::NumericVector&amp; parameters, Rcpp::List&amp; data){</span></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a><span class="st">    // our function now only takes the two specified arguments: a</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a><span class="st">  // const Rcpp::NumericVector&amp; and an Rcpp::List&amp;.</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a><span class="st">  // We have to extract all elements from the list:</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a><span class="st">  arma::colvec y = Rcpp::as&lt;arma::colvec&gt;(data[&quot;y&quot;]); // the dependent variable</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a><span class="st">  arma::mat X = Rcpp::as&lt;arma::mat&gt;(data[&quot;X&quot;]); // the design matrix</span></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a><span class="st">  int N = Rcpp::as&lt;int&gt;(data[&quot;N&quot;]); // the sample size</span></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a><span class="st">  // Next, we want to get the parameters as a column-vector:</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a><span class="st">    arma::colvec b = Rcpp::as&lt;arma::colvec&gt;(parameters);</span></span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a><span class="st">  // note: we want to return our gradients as row-vector; therefore,</span></span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a><span class="st">  // we have to transpose the resulting column-vector:</span></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a><span class="st">    arma::rowvec gradients = arma::trans(-2.0*X.t() * y + 2.0*X.t()*X*b);</span></span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a><span class="st">    // other packages, such as glmnet, scale the sse with </span></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a><span class="st">    // 1/(2*N), where N is the sample size. We will do that here as well</span></span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a><span class="st">    gradients *= (.5/N);</span></span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a><span class="st">    return(gradients);</span></span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a><span class="st">/// THE FOLLOWING PART IS NEW:</span></span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a><span class="st">// INSTRUCTIONS: ADD THE FOLLOWING LINES TO YOUR C++ FUNCTIONS</span></span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a><span class="st">// IF RCPPARMADILLO IS NOT IMPORTED YET, UNCOMMENT THE FOLLOWING TWO LINES</span></span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a><span class="st">// // [[Rcpp::depends(RcppArmadillo)]]</span></span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a><span class="st">// #include &lt;RcppArmadillo.h&gt;</span></span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a><span class="st">// https://gallery.rcpp.org/articles/passing-cpp-function-pointers/</span></span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a><span class="st">typedef double (*fitFunPtr)(const Rcpp::NumericVector&amp;, //parameters</span></span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a><span class="st">                Rcpp::List&amp; //additional elements</span></span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a><span class="st">);</span></span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a><span class="st">typedef Rcpp::XPtr&lt;fitFunPtr&gt; fitFunPtr_t;</span></span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a><span class="st">typedef arma::rowvec (*gradientFunPtr)(const Rcpp::NumericVector&amp;, //parameters</span></span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a><span class="st">                      Rcpp::List&amp; //additional elements</span></span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a><span class="st">);</span></span>
<span id="cb20-72"><a href="#cb20-72" aria-hidden="true" tabindex="-1"></a><span class="st">typedef Rcpp::XPtr&lt;gradientFunPtr&gt; gradientFunPtr_t;</span></span>
<span id="cb20-73"><a href="#cb20-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-74"><a href="#cb20-74" aria-hidden="true" tabindex="-1"></a><span class="st">// [[Rcpp::export]]</span></span>
<span id="cb20-75"><a href="#cb20-75" aria-hidden="true" tabindex="-1"></a><span class="st">fitFunPtr_t fitfunctionPtr() {</span></span>
<span id="cb20-76"><a href="#cb20-76" aria-hidden="true" tabindex="-1"></a><span class="st">        return(fitFunPtr_t(new fitFunPtr(&amp;fitfunction)));</span></span>
<span id="cb20-77"><a href="#cb20-77" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb20-78"><a href="#cb20-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-79"><a href="#cb20-79" aria-hidden="true" tabindex="-1"></a><span class="st">// [[Rcpp::export]]</span></span>
<span id="cb20-80"><a href="#cb20-80" aria-hidden="true" tabindex="-1"></a><span class="st">gradientFunPtr_t gradientfunctionPtr() {</span></span>
<span id="cb20-81"><a href="#cb20-81" aria-hidden="true" tabindex="-1"></a><span class="st">        return(gradientFunPtr_t(new gradientFunPtr(&amp;gradientfunction)));</span></span>
<span id="cb20-82"><a href="#cb20-82" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb20-83"><a href="#cb20-83" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;</span></span></code></pre></div>
<p>Compile the functions using Rcpp:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>Rcpp<span class="sc">::</span><span class="fu">sourceCpp</span>(<span class="at">code =</span> linreg)</span></code></pre></div>
<p>Great! Now that this is out of the way, we can create the pointers to
our functions:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>ffp <span class="ot">&lt;-</span> <span class="fu">fitfunctionPtr</span>() <span class="co"># create the pointer to the fitting function</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that the name of this function will depend on the name of your fitting function.</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co"># For instance, if your fitting function is called sse, then the pointer will be created </span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># with ffp &lt;- ssePtr()</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>gfp <span class="ot">&lt;-</span> <span class="fu">gradientfunctionPtr</span>() <span class="co"># create the pointer to the gradient function</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that the name of this function will depend on the name of your gradient function.</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co"># For instance, if your gradient function is called sseGradient, then the pointer will be created </span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co"># with gfp &lt;- sseGradientPtr()</span></span></code></pre></div>
</div>
<div id="optimizing-the-model" class="section level3">
<h3>Optimizing the model</h3>
<p>The last step is to call the general purpose optimization. To this
end, use the <code>gpLassoCpp</code> function:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>l1 <span class="ot">&lt;-</span> <span class="fu">gpLassoCpp</span>(<span class="at">par =</span> par, </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">regularized =</span> regularized, </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># important: pass the poinnters!</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">fn =</span> ffp, </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">gr =</span> gfp, </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">lambdas =</span> lambdas, </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># finally, pass the list which the fitting function and the </span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># gradient function need:</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">additionalArguments =</span> data</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(l1<span class="sc">@</span>parameters)</span></code></pre></div>
<pre><code>#&gt;        lambda alpha         b0        b1        b2        b3       b4
#&gt; 1 0.000000000     1 0.02734701 1.0129361 0.9991629 0.9705501 1.027728
#&gt; 2 0.005263158     1 0.02939675 1.0043635 0.9908681 0.9626493 1.025035
#&gt; 3 0.010526316     1 0.02998680 0.9967117 0.9846504 0.9552960 1.021803
#&gt; 4 0.015789474     1 0.03006777 0.9897315 0.9789595 0.9481301 1.018774
#&gt; 5 0.021052632     1 0.03032345 0.9827556 0.9731799 0.9409662 1.015441
#&gt; 6 0.026315789     1 0.03111085 0.9753325 0.9670615 0.9338506 1.011607
#&gt;            b5           b6           b7          b8           b9         b10
#&gt; 1 0.013993181 -0.007491533 0.0186210155 0.021974963 -0.009975776 0.027466466
#&gt; 2 0.003400965  0.000000000 0.0143089363 0.015388336 -0.007860992 0.022231196
#&gt; 3 0.000000000  0.000000000 0.0095927088 0.010679371 -0.005183552 0.017406513
#&gt; 4 0.000000000  0.000000000 0.0049636831 0.006397664 -0.002474334 0.012779758
#&gt; 5 0.000000000  0.000000000 0.0001374354 0.002100692  0.000000000 0.008033475
#&gt; 6 0.000000000  0.000000000 0.0000000000 0.000000000  0.000000000 0.003352431</code></pre>
<p>Benchmarking this approach results in:</p>
<pre><code>#&gt; [1] 0.005872965 0.005683661 0.005662680 0.006442070 0.006541729</code></pre>
<p>So, we have reduced our run time even more!</p>
</div>
</div>
<div id="the-third-approach-including-the-header-files" class="section level2">
<h2>The third approach: Including the header files</h2>
<p>This is, by far, the most difficult approach which is why we have
created a whole package to demonstrate it. You will find more
information in the vignette <code>The-optimizer-interface</code> and in
the <a href="https://github.com/jhorzek/lessLM">lessLM</a> package.</p>
<p>It will come to the same parameter estimates:</p>
<pre><code>#&gt;              b0        b1        b2        b3       b4          b5           b6
#&gt; [1,] 0.02734701 1.0129361 0.9991629 0.9705501 1.027728 0.013993181 -0.007491533
#&gt; [2,] 0.02939675 1.0043635 0.9908681 0.9626493 1.025035 0.003400965  0.000000000
#&gt; [3,] 0.02998680 0.9967117 0.9846504 0.9552960 1.021803 0.000000000  0.000000000
#&gt; [4,] 0.03006777 0.9897315 0.9789595 0.9481301 1.018774 0.000000000  0.000000000
#&gt; [5,] 0.03032345 0.9827556 0.9731799 0.9409662 1.015441 0.000000000  0.000000000
#&gt; [6,] 0.03111085 0.9753325 0.9670615 0.9338506 1.011607 0.000000000  0.000000000
#&gt;                b7          b8           b9         b10
#&gt; [1,] 0.0186210155 0.021974963 -0.009975776 0.027466466
#&gt; [2,] 0.0143089363 0.015388336 -0.007860992 0.022231196
#&gt; [3,] 0.0095927088 0.010679371 -0.005183552 0.017406513
#&gt; [4,] 0.0049636831 0.006397664 -0.002474334 0.012779758
#&gt; [5,] 0.0001374354 0.002100692  0.000000000 0.008033475
#&gt; [6,] 0.0000000000 0.000000000  0.000000000 0.003352431</code></pre>
<p>And the run times are even lower:</p>
<pre><code>#&gt; [1] 0.0015168190 0.0008740425 0.0008568764 0.0008738041 0.0008821487</code></pre>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
